{% extends "base.html" %}

{% block title %}Case Studies - LLM Math Evaluation Results{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">üîç Case Study Browser</h1>
        <p class="lead">Detailed analysis of individual questions and model responses</p>
    </div>
</div>

<!-- Filters Section -->
<div class="filter-section">
    <h5>üéõÔ∏è Filters</h5>
    <form id="filterForm">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="modelSelect" class="form-label">Model</label>
                <select class="form-select" id="modelSelect" name="model">
                    <option value="">All Models</option>
                    {% for model in models %}
                    <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="datasetSelect" class="form-label">Dataset</label>
                <select class="form-select" id="datasetSelect" name="dataset">
                    <option value="">All Datasets</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset }}">{{ dataset }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="correctSelect" class="form-label">Correctness</label>
                <select class="form-select" id="correctSelect" name="correct_only">
                    <option value="">All</option>
                    <option value="true">Correct Only</option>
                    <option value="false">Incorrect Only</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="levelSelect" class="form-label">Difficulty</label>
                <select class="form-select" id="levelSelect" name="difficulty_level">
                    <option value="">All Levels</option>
                    {% for level in levels %}
                    <option value="{{ level }}">Level {{ level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block">üîç Filter</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8 mb-3">
                <label for="searchInput" class="form-label">Search in Questions</label>
                <input type="text" class="form-control" id="searchInput" name="question_contains" 
                       placeholder="Enter keywords to search in question text...">
            </div>
            <div class="col-md-2 mb-3">
                <label for="perPageSelect" class="form-label">Per Page</label>
                <select class="form-select" id="perPageSelect" name="per_page">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-outline-secondary d-block" onclick="clearFilters()">üîÑ Clear</button>
            </div>
        </div>
    </form>
</div>

<!-- Results Info -->
<div id="resultsInfo" class="alert alert-info" style="display: none;">
    <span id="resultsText"></span>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Results Container -->
<div id="resultsContainer">
    <!-- Results will be loaded here -->
</div>

<!-- Pagination -->
<nav id="paginationContainer" style="display: none;">
    <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination will be loaded here -->
    </ul>
</nav>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentFilters = {};

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    // Check URL parameters for initial filters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('model')) {
        document.getElementById('modelSelect').value = urlParams.get('model');
    }
    if (urlParams.get('dataset')) {
        document.getElementById('datasetSelect').value = urlParams.get('dataset');
    }
    
    loadCases();
});

// Form submission
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    loadCases();
});

function loadCases(page = 1) {
    currentPage = page;
    
    // Show loading spinner
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsContainer').innerHTML = '';
    document.getElementById('paginationContainer').style.display = 'none';
    
    // Collect form data
    const formData = new FormData(document.getElementById('filterForm'));
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    params.append('page', page);
    
    // Store current filters
    currentFilters = Object.fromEntries(params.entries());
    
    // Fetch data
    fetch('/api/cases?' + params.toString())
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingSpinner').style.display = 'none';
            renderResults(data);
            renderPagination(data);
            updateResultsInfo(data);
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        })
        .catch(error => {
            console.error('Error loading cases:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('resultsContainer').innerHTML = 
                '<div class="alert alert-danger">Error loading cases. Please try again.</div>';
        });
}

function renderResults(data) {
    const container = document.getElementById('resultsContainer');
    
    if (data.results.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No cases found matching your criteria.</div>';
        return;
    }
    
    let html = '';
    data.results.forEach((result, index) => {
        const isCorrect = result.score[0];
        const cardClass = isCorrect ? 'correct' : 'incorrect';
        const badgeClass = isCorrect ? 'bg-success' : 'bg-danger';
        const badgeText = isCorrect ? '‚úì Correct' : '‚úó Incorrect';
        
        html += `
        <div class="card mb-4 ${cardClass}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <span class="badge bg-secondary me-2">Question #${result.idx + 1}</span>
                    <span class="badge ${badgeClass}">${badgeText}</span>
                    <span class="badge bg-primary ms-2">${result.model}</span>
                    ${result.level ? `<span class="badge bg-info ms-1">Level ${result.level}</span>` : ''}
                </h6>
                <button class="btn btn-outline-secondary btn-sm" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                    Toggle Details
                </button>
            </div>
            <div class="card-body">
                <div class="question-text">
                    <h6>üìù Question:</h6>
                    <div>${result.question}</div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <strong>üéØ Ground Truth:</strong>
                        <div class="mt-1"><code>${result.gt || result.answer}</code></div>
                    </div>
                    <div class="col-md-6">
                        <strong>ü§ñ Model Prediction:</strong>
                        <div class="mt-1"><code>${result.pred[0] || 'No prediction'}</code></div>
                    </div>
                </div>
                
                <div class="collapse mt-3" id="collapse${index}">
                    <hr>
                    ${result.code && result.code[0] ? `
                    <div class="prediction-text">
                        <h6>üí≠ Model Reasoning:</h6>
                        <div style="max-height: 300px; overflow-y: auto;">${result.code[0].replace(/\n/g, '<br>')}</div>
                    </div>
                    ` : ''}
                    
                    ${result.gt_cot ? `
                    <div class="mt-3">
                        <h6>üìö Reference Solution:</h6>
                        <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                            ${result.gt_cot.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            Dataset: ${result.dataset} | 
                            Finish Reason: ${result.finish_reason[0] || 'N/A'}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderPagination(data) {
    if (data.total_pages <= 1) {
        document.getElementById('paginationContainer').style.display = 'none';
        return;
    }
    
    document.getElementById('paginationContainer').style.display = 'block';
    const pagination = document.getElementById('pagination');
    
    let html = '';
    
    // Previous button
    html += `
    <li class="page-item ${data.page === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadCases(${data.page - 1}); return false;">Previous</a>
    </li>
    `;
    
    // Page numbers
    for (let i = Math.max(1, data.page - 2); i <= Math.min(data.total_pages, data.page + 2); i++) {
        html += `
        <li class="page-item ${i === data.page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadCases(${i}); return false;">${i}</a>
        </li>
        `;
    }
    
    // Next button
    html += `
    <li class="page-item ${data.page === data.total_pages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadCases(${data.page + 1}); return false;">Next</a>
    </li>
    `;
    
    pagination.innerHTML = html;
}

function updateResultsInfo(data) {
    const info = document.getElementById('resultsInfo');
    const text = document.getElementById('resultsText');
    
    if (data.total > 0) {
        const start = (data.page - 1) * data.per_page + 1;
        const end = Math.min(start + data.per_page - 1, data.total);
        text.textContent = `Showing ${start}-${end} of ${data.total} cases`;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function clearFilters() {
    document.getElementById('filterForm').reset();
    currentPage = 1;
    loadCases();
}
</script>
{% endblock %}
