{% extends "base.html" %}

{% block title %}Model Comparison - LLM Math Evaluation Results{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">‚öñÔ∏è Model Comparison</h1>
        <p class="lead">Side-by-side comparison of different model configurations</p>
    </div>
</div>

<!-- Comparison Charts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">üìä Performance Comparison</h5>
            </div>
            <div class="card-body">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">üéØ Accuracy Analysis</h5>
            </div>
            <div class="card-body">
                <canvas id="accuracyRadarChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">‚è±Ô∏è Efficiency Analysis</h5>
            </div>
            <div class="card-body">
                <canvas id="efficiencyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Head-to-Head Comparison -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">üîÑ Head-to-Head Comparison</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="model1Select" class="form-label">Select Model 1:</label>
                        <select class="form-select" id="model1Select">
                            <option value="">Choose a model...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="model2Select" class="form-label">Select Model 2:</label>
                        <select class="form-select" id="model2Select">
                            <option value="">Choose a model...</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="compareModels()">Compare Models</button>
                </div>
                <div id="comparisonResults" class="mt-4" style="display: none;">
                    <!-- Comparison results will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let comparisonData = {};

// Load comparison data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadComparisonData();
});

function loadComparisonData() {
    fetch('/api/comparison_data')
        .then(response => response.json())
        .then(data => {
            comparisonData = data;
            renderComparisonChart();
            renderAccuracyRadarChart();
            renderEfficiencyChart();
            populateModelSelects();
        })
        .catch(error => {
            console.error('Error loading comparison data:', error);
        });
}

function renderComparisonChart() {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    // Prepare data for all datasets
    const datasets = [];
    const colors = [
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 99, 132, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)'
    ];
    
    Object.keys(comparisonData).forEach((dataset, datasetIndex) => {
        const models = comparisonData[dataset];
        datasets.push({
            label: dataset,
            data: models.map(model => model.accuracy),
            backgroundColor: colors[datasetIndex % colors.length],
            borderColor: colors[datasetIndex % colors.length].replace('0.8', '1'),
            borderWidth: 1
        });
    });
    
    // Get all unique model names
    const allModels = new Set();
    Object.values(comparisonData).forEach(models => {
        models.forEach(model => allModels.add(model.model));
    });
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from(allModels),
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Accuracy (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Models'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Model Performance Across Datasets'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

function renderAccuracyRadarChart() {
    const ctx = document.getElementById('accuracyRadarChart').getContext('2d');
    
    // Prepare data for radar chart
    const allModels = new Set();
    Object.values(comparisonData).forEach(models => {
        models.forEach(model => allModels.add(model.model));
    });
    
    const datasets = Array.from(allModels).map((modelName, index) => {
        const accuracyData = Object.keys(comparisonData).map(dataset => {
            const model = comparisonData[dataset].find(m => m.model === modelName);
            return model ? model.accuracy : 0;
        });
        
        const colors = [
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 99, 132, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(255, 205, 86, 0.2)'
        ];
        
        return {
            label: modelName,
            data: accuracyData,
            backgroundColor: colors[index % colors.length],
            borderColor: colors[index % colors.length].replace('0.2', '1'),
            pointBackgroundColor: colors[index % colors.length].replace('0.2', '1'),
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: colors[index % colors.length].replace('0.2', '1')
        };
    });
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: Object.keys(comparisonData),
            datasets: datasets
        },
        options: {
            responsive: true,
            elements: {
                line: {
                    borderWidth: 3
                }
            },
            scales: {
                r: {
                    angleLines: {
                        display: false
                    },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Model Accuracy Comparison by Dataset'
                }
            }
        }
    });
}

function renderEfficiencyChart() {
    const ctx = document.getElementById('efficiencyChart').getContext('2d');
    
    // Prepare efficiency data (accuracy per minute)
    const efficiencyData = [];
    const labels = [];
    const colors = [];
    
    Object.values(comparisonData).forEach(models => {
        models.forEach((model, index) => {
            const timeMinutes = parseFloat(model.time_minutes.split(':')[0]) + 
                              parseFloat(model.time_minutes.split(':')[1]) / 60;
            const efficiency = model.accuracy / timeMinutes;
            
            efficiencyData.push({
                x: timeMinutes,
                y: model.accuracy,
                efficiency: efficiency
            });
            labels.push(model.model);
            colors.push(`rgba(${54 + index * 50}, ${162 + index * 30}, ${235 - index * 40}, 0.8)`);
        });
    });
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Efficiency (Accuracy vs Time)',
                data: efficiencyData,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1')),
                pointRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Processing Time (minutes)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Accuracy (%)'
                    },
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const modelIndex = context.dataIndex;
                            const model = labels[modelIndex];
                            const efficiency = context.raw.efficiency;
                            return `${model}: ${context.parsed.y.toFixed(1)}% in ${context.parsed.x.toFixed(1)} min (${efficiency.toFixed(2)} acc/min)`;
                        }
                    }
                },
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Efficiency Analysis: Accuracy vs Processing Time'
                }
            }
        }
    });
}

function populateModelSelects() {
    const allModels = new Set();
    Object.values(comparisonData).forEach(models => {
        models.forEach(model => allModels.add(model.model));
    });
    
    const model1Select = document.getElementById('model1Select');
    const model2Select = document.getElementById('model2Select');
    
    Array.from(allModels).forEach(model => {
        const option1 = new Option(model, model);
        const option2 = new Option(model, model);
        model1Select.add(option1);
        model2Select.add(option2);
    });
}

function compareModels() {
    const model1 = document.getElementById('model1Select').value;
    const model2 = document.getElementById('model2Select').value;
    
    if (!model1 || !model2) {
        alert('Please select both models to compare');
        return;
    }
    
    if (model1 === model2) {
        alert('Please select different models to compare');
        return;
    }
    
    // Find model data
    let model1Data = null;
    let model2Data = null;
    
    Object.values(comparisonData).forEach(models => {
        models.forEach(model => {
            if (model.model === model1) model1Data = model;
            if (model.model === model2) model2Data = model;
        });
    });
    
    if (!model1Data || !model2Data) {
        alert('Model data not found');
        return;
    }
    
    // Display comparison results
    const resultsDiv = document.getElementById('comparisonResults');
    resultsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">${model1}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-value text-primary">${model1Data.accuracy.toFixed(1)}%</div>
                                <div class="metric-label">Accuracy</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-info">${model1Data.time_minutes}</div>
                                <div class="metric-label">Time</div>
                            </div>
                        </div>
                        <hr>
                        <small class="text-muted">
                            Empty responses: ${model1Data.empty_samples}<br>
                            Timeouts: ${model1Data.timeout_samples}
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">${model2}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-value text-success">${model2Data.accuracy.toFixed(1)}%</div>
                                <div class="metric-label">Accuracy</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-info">${model2Data.time_minutes}</div>
                                <div class="metric-label">Time</div>
                            </div>
                        </div>
                        <hr>
                        <small class="text-muted">
                            Empty responses: ${model2Data.empty_samples}<br>
                            Timeouts: ${model2Data.timeout_samples}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <div class="alert ${model1Data.accuracy > model2Data.accuracy ? 'alert-primary' : 'alert-success'}">
                <strong>Winner:</strong> ${model1Data.accuracy > model2Data.accuracy ? model1 : model2} 
                (${Math.abs(model1Data.accuracy - model2Data.accuracy).toFixed(1)} percentage points difference)
            </div>
        </div>
    `;
    resultsDiv.style.display = 'block';
}
</script>
{% endblock %}
